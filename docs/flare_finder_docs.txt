'''INTRO
    
    Welcome, this is the TESS Overlapping Flare Finder and Energy Evaluator
    (TOFFEE) flare finder

    This code works by taking a raw lightcurve, detrending it, then searching for
    primary flares and secondary flares within the primary flares. It's been trained
    for 120 second data and so it's advised to use the same data when running the program.

    We call this a "top-down" approach as instead of scanning a lightcurve
    from left to right, looking at every single photometric point, we only look
    at all the points above a given flux threshold. 
    
    For those points we start at the brightest points, starting from the peaks and modeling
    around it to find the beginning and the end of the flare using a series of conditions
    if there are sufficient enough points above the threshold it's counted as a flare and added
    to the catalog. We call these flares primaries as they're found first

    If the flare has a good number of points in the rise to the left of the peak and in the decay
    to the right of the peak it's worthwhile to search for a secondary. To the rise we can fit a variety
    of models such as a quadratic or gaussian (although we find gaussian to work much better for 120 second
    TESS data). It fits a double exponential to the decay (no other model worked well at all). In the residuals,
    defined as the difference of the flux points and the value of the flux from the fitted model, we try to find major
    deviations from the expected behaviors. If we see three or more points above a threshold, boom, another flare
    has been found within the first one. We call this the secondary flare becuase it was found second.
    
    Note we call it a secondary regardless of whether or not it occurs before or after the primary. It's just named based
    on the order we found the flares and the secondary flares always have a lower
    peak flux (not necessarily amplitude) than the primary.
    
    All the other bright points above the threshold that were found to belong
    to this flare are thrown out and the code moves onto the next peak and starts again.

    '''


    '''ARGUMENTS

    These arguments should be 1D array-like objects of equal size

    time: the time coordinates of the lightcurve in BJD. The detrending utilizes the orbit timing so these should be
          in the default units from lightkurve.

    flux: Photometric flux. Can either be in raw units of e/sec becuase we'll normalized later or can be normalized already.

    flux_err: Photometric error on the cadences.
              Can either be in raw units of e/sec becuase we'll normalize later or can be normalized already.

    quality: quality flag of the cadence from TESS. We utilize filtering to remove poor quality readings from the
             lightcurves to ensure more accurate detection. If you want to skip this step then you can just make
             an array of equal length to the time, flux, and flux_err arrays and fill it with the value 0.

    LIGHTCURVE PREPARATION

    flag_values: A list of the acceptable flag values you want to include in the analysis. By default we only
                 permit cadences with a perfect quality of zero into the analysis. However it has been shown that
                 points with a flag value of 512 can correspond to the peaks of flares and so can be kept in. For that
                 you can pass flag_values = [0, 512] to include them. The other will be masked out.

    detrend: boolean value representing whether or not to detrend the lightcurve. 
    
             If True TOFFEE will detrend using biwieght detrending. If not, TOFFEE will skip this
             and go straight to detection. TOFFEE relies on detrending to find flare signals however
             if the lightcurve has been detrended beforehand using a preferred method you
             may want to skip detrending again which may eat into the flare signal.

    window_length: float value representing the window length of wotan detrending (Hippke et al. (2019, AJ, 158, 143)).

    periodogram: None value or list of length 2 in the form [min_period, max_period]. Periodogram iteratively runs LS test
                 on lightcurve post Wotan detrend to find residual periodic red noise and flatten it using sine fit.
                 The periods of such fits are in the range (min_period, max_period) such that min_period is the smallest period
                 in days considered for the fit and max_period is the maximum period tested. In our analysis we find [0.01, 10] to 
                 work effectively, needing to capture the rapid rotators that majorly affect fitting.

    TOFFEE also clips all breaks in the lightcurve to avoid edge effects of detrending creating false positve signals.

    min_break: float value represening the smallest duration of a break in the lightcurve (in days) for which TOFFEE will
               mask out points on either side. Default is set to 0.25, the same value as the default window length for Wotan.
               In Pratt et al 2025 we used a value of 0.025 days to be super conservative.

    clip_breaks: The number of cadences to clip out on either side of a break detected by min_break. Default is 100 cadences
                 which corresponds to 200 minutes of data in 120 sec cadence data from TESS.

    

    PRIMARY FLARE DETECTION ARGUMENTS

    magic_flare_std: Integer or float value greater than 0. Sets the threshold for detection of primary flares in terms of sigma of the global
                     spread of photometry points. Default value is set to 3σ which is the common value for threshold-based detection.

    consecutive: boolean value representing how a primary flare will be determined. 
    
                 If true a flare will be counted only if three consecutive points are above the threshold.
                 This is consistent with many other threshold-based methods. It's easy to follow and generally
                 works well. However, for some detrendended lightcurves certain artifacts of the detrending
                 may pop up as false-positive signals.
                 
                 If false a flare will be counted even if not every point is above the threshold.

                 The non-consecutive case which we call the 'three in four rule' works to both include low amp
                 flares that don't have three consecutive points above the threshold and rule out signals that
                 result from detrending artifacts. It works by starting from the peak of the flare and looking
                 to the left to find the start of the flare. A flare is considered to have begun when the next
                 three points to the left of some cadence all lie well under the threshold (1σ less than the threshold).
                 Then the code looks to the right, saying a flare has ended when the next three points to the right of some cadence
                 are all well below the threshold (1σ less than the threshold). In this way we try to say with confidence that
                 a flare event has truly begun and ended and can include points below the threshold.

                 Then TOFFEE reads where the first point associated with the flare was above the threshold and where
                 the last point associated with the flare was above the threshold. If 75% of the points between them are
                 above the flux threshold then we call it a flare as we see a true signal. So if there's a small signal where
                 there are three cadences above the threshold separated by one cadence below the threshold it's still a flare.
                 In practice this one cadence below the threshold is only just below the threshold of detection so visually
                 it still passes as a flare.

                 While catching low amp flares it also catches incomplete detrending where there is residual modulation.
                 Leftover red noise can occasianally rise above the flux threshold being falsly flagged as a flare. This condition
                 helps to eliminate such false-positives because they tend to fluctuate around the threshold for a while, causing
                 the fraction of points above the threshold as opposed to below the threshold to be lower than 75%.

                 The only catch is the case where a flare occurs during this positive modulation. In that case it's quite tricky
                 to recover them. To save quality signals we still recover the flares if the amplitude is sufficiently high.
                 Sufficiently high is defined as being 1.5x the original flux threshold for detection. This typically finds obvious
                 flares while keeping away false-positive detection when using the typical threshold value of 3σ.

    prim_marg_rate: float value from 0.0 to 1.0 representing the threshold value for a cadence to be
                    consideres a part of a flare. Rather than being the sigma threshold itslef it's a
                    fraction of the primary flare sigma. For example, with the default primary flare threshold
                    of 3σ and the default prim_marg_rate of 0.67 cadences flux points with values of 2σ can be
                    considered a part of the flare. You want something low enough that you can catch the epochs of the
                    lightcurve above the threshold that may be separated by one or two other cadences but no too low that
                    an unreasonable number of points are included in the flare and the start and end times are poor.

    rate_above_threshold: float value between 0.0 and 1.0. If using the nonconsecutve detection for primary flares
                          (consecutive = False) rate_above_threshold determines the minimum fraction of points above
                          the flux threshold compared to the total number of points in the flare to be called a flare.
                          The default is 0.75 where the 'three in four rule' gets its name but can be altered depending on
                          the purpose of the user. Higher values will result in stricter requirements (0.9 requires 90% of the
                          flux points to be above the threshold) and lower values loosen requirements. We find 0.75 to be the
                          minimum while comfortably getting quality flares as opposed to 0.6 (or a 'three in five rule').

    SECONDARY FLARE DETECTION ARGUMENTS

    sec_flare_std: Integer or float value greater than 0. Sets the threshold for detection of primary flares in terms of sigma of the global
                   spread of photometry points. Default value is set to 2σ.

    rise_func: str variable of value 'gaussian' or 'quad' determining the model used to fit the rise. If 'gaussian' is applied
               then the rise will be modeled by a guassian rise function. If 'quad' is applied then a quadratic rise will be used.
               'gaussian' is recommended for 120 sec data

    sec_marg_rate:  float value from 0.0 to 1.0 representing the threshold value for a cadence to be
                    consideres a part of a fsecondary lare. Rather than being the sigma threshold itslef it's a
                    fraction of the secondary flare sigma. For example, with the default primary flare threshold
                    of 2σ and the default prim_marg_rate of 0.75 cadences flux points with values of 1.5σ can be
                    considered a part of the secondary flare. It's used to determine whether or not a secondary flare
                    was missed because of it's affect on the fit. A default value of sec_marg_rate = 0.75 with
                    sec_flare_std = 2.0 means that if there are three points 1.5σ above the fitted model then
                    there is a possible secondary and it's worth refitting without those points.

    fit_twice: boolean value representing whether or not to attempt refitting of the decay in the case where a potential
               secondary flare was missed because of it's affect in lifting up the fit. A marginal flare is defined as an
               event in the residual where three consecutive points are at least 75% of the desired threshold.

    fit_multiple_secs: boolean value representing whether or not to search for more than one secondary flare event in the residual
                       of the decay of a flare, finding possible teritiary and even quartic flares. We initially leave this off
                       as it often picks up Quasi-Periodic Pulsations as these tertiary flares but it could be useful if that's
                       your goal.


    PLOTTING FLARE FITS ARGUMENTS
    TOFFEE also has built in plotting for the fittings of flares and finding secondary flares. If you don't want to see them
    you can leave visualize_fit in the default state of False. If you do then set visualize_fit = True but you don't need to mess with most of
    the arguments unless you really want a different color pallette or the TIC and Sector plotted as well.

    visualize_fit: boolean value representing whether or not to plot each attempted fit for primary flares along with residuals
                   and overplotting of primary and secondary flares. Does not show ALL flares, only ones where a fit was attempted.
                   If true fits and residuals will be plotted, if false this step will be skipped.

    IF visualize_fit = True, these variables will be passed

    primary_color = string variable for the color of the points associated with a primary flare event.

    secondary_color = string variable for the color of the points associated with a secondary flare event.

    tertiary_color = string variable for the color of the points associated with a tertiary flare event.

    cadence_color = string variable for the color of the TESS photometry points not associated with flares.

    threshold_color = string variable for the color of the horizontal line representing the flux threshold for primary flare detection.

    fit_color = string variable for the color of the parameterized curves for the rise and decay of the flares.

    fontsize = integer variable for the fontsize of the axes labels and titles of the plots from visualize_fit

    labelsize = integer variable for the fontsize of the labels on the axes

    TIC_number = integer variable for the TIC Number of the star from which the lightcurve comes from. Useful when plotting
                 the flare fits from many stars.

    TESS_sector = integer variable for the TESS Sector Number from which the lightcurve comes from. Useful when plotting the flare fits
                  for multiple sectors of a star.

    

    '''



    '''RETURNS

    The returns of the code are a suite of physical and data based measurements:

    flare_peak_times, flare_start_times, flare_end_times, flare_amps, flare_equivalent_durations,
    primary_or_secondary, points_in_flare, points_abv_threshold, amp_sigma


    flare_peak_times: Times (in BTJD), of the peaks of the flares, the moments of brightest emission

    
    flare_start_times: Time marking the beginning of the flares before the sudden rise

    
    flare_end_times: Time marking the end of the flares after the decay

    
    NOTE: The flare start and end times are a bit finnicky based on how you define it in the
          code. We advise using the peak times as a better characterization of when the flare occurs.

    
    flare_amps: the flux of the peak emission normalized to the median emission for the star. This is with
                the background emission of the star subtracted out so it's just the emission of the flare

    
    flare_equivalent_durations: Used for finding the energies. Defined as the equivalent amount of time (in seconds)
                                that the star would need to shine in order to emit the same amount of energy as the flare.
                                Found by integrating the flux of the flare with respect to time using the trapezoidal rule
                                after subtracting the background emission of the star. Multiplying the ED by the luminosity
                                of the star finds the energy of the flare.

    
    primary_or_secondary: Label telling how this flare was found. Comes in four flavors.
    
                          "primary": Means this is a flare that was found where the peak was identified,
                                     it was modeled, and passed the checks. There may or may not have been
                                     a fit applied to the rise and decay. There may or may nor have been a
                                     secondary found to this flare.
                          
                          "primary_dbl_fit_failed": A special type of primary flare in which a double exponential
                                                    was fit to the decay with no secondary found. However it seemed
                                                    like there was possibly another flare that was just missed so it
                                                    tried to refit the decay and still didn't find a secondary. We keep
                                                    track of these to see the relative success of these attempted refittings
                                                    to find more secodnary flares.

                         "secondary": Means this flare was found within a primary flare. It may be in the rise or the decay.
                                      It was found on the first attempt of fitting a model to the rise and decay with no need
                                      for a refit

                         "secondary_second_try": A special type of secondary that was found in the decay of a flare only
                                                 after refitting the model without brighter points that affected the first
                                                 fit


    points_in_flare: Number of flux points identified with the flare.

    
    points_abv_threshold: Not all points associated with the primary flare are necessarily above the threshold, the conditions
                          are complicated depending on what setting you use to identify the beginning and end. So we
                          also keep track of the number of points in the flare above the detection threshold.


    amp_sigma: The amplitude of the flare divided by the spread of the photometric points. Tells us how much the peak of the
               flare rises relative to the noise of the lightcurve.

    
    '''

    '''FUTURE WORK
    
    TOFFEE is always looking for improvement in performance and flexibility. There are a few outstanding challenges for the
    project in terms of secondary detection. 
    
    1) Seeking tertiary and other high order flares. The issue comes
    from the effect of Quasi-Periodic Pulsations that get flagged as loads of secondary flares. While this is perhaps a
    cool way to find such events in a large sample it's not good when you want quality sources. One solution is to test
    for periodicity in the events (whether or not the primary and secondary are equally spaced in time to the secondary and
    tertiary). 
    
    2) The conditions for secondary detection are still a little rigid. It has been shown limiting detection
    to only two cadences above 3σ is good for finding flares. Or maybe you want super obvious flares so you want 4 cadences above
    5σ. We're adding that flexibility as well.

    3) As best as we tried the detrending is not perfect. For pulsating stars in particular the fits are not great yet
    when the program lands on a solution TOFFEE just goes ahead to detect flare signals.
    We're adding filtering so you can only search for flares on lightcurves for which the detrending 
    actually flattens the light curve.

    '''
